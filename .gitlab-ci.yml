image: microsoft/dotnet:latest

variables:
  BUILD_DIR: "realpath `pwd`"
  NUGET_PACKAGES: "$BUILD_DIR/.nuget"

cache:
  paths:
    - "$NUGET_PACKAGES"
  # keep cache across branch
  key: "$CI_BUILD_REF_NAME"

stages:
  - build
  - test
  - deploy

build-job:
  stage: build
  script:
    - dotnet restore
    - . ./build-all.sh
  artifacts:
    paths:
      - "./*/*/bin"
      - "./*/*/obj"
      - "./*/*/project.lock.json"

unittest-job:
  stage: test
  dependencies:
    - build-job
  script:
    - dotnet restore
    - . ./test-all.sh
      #- echo "TotalInstructionCoverage:" `cat target/site/jacoco/jacoco.xml | grep -E '<counter type="INSTRUCTION"[^>]*/>' -o | tail -n 1 | sed -E 's@<counter type="INSTRUCTION"[ ]+missed="([0-9]+)"[ ]+covered="([0-9]+)"[ ]*/>@scale=2;100*(\2)/(\1+\2)@' | bc`
  artifacts:
    paths:
      - "./*/*/bin"
      - "./*/*/obj"
      - "./*/*/project.lock.json"

#integrationtest-job:
#  stage: test
#  dependencies:
#    - build-job
#  script:
#    - dotnet restore
#    - dotnet test
#    - echo "TotalInstructionCoverage:" `cat target/site/jacoco-it/jacoco.xml | grep -E '<counter type="INSTRUCTION"[^>]*/>' -o | tail -n 1 | sed -E 's@<counter type="INSTRUCTION"[ ]+missed="([0-9]+)"[ ]+covered="([0-9]+)"[ ]*/>@scale=2;100*(\2)/(\1+\2)@' | bc`
#  artifacts:
#    paths:
#      - "./*/*/bin"
#      - "./*/*/obj"
#      - "./*/*/project.lock.json"

deploy-job:
  stage: deploy
  script:
    - dotnet restore
    - . ./publish-all.sh
  artifacts:
    paths:
       - "./*/*/bin/*/*.nupkg"

